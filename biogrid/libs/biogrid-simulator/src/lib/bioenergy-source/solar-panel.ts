import { WeatherLib } from '@biogrid/weather';
import { EnergySource } from './bioenergy-source';
import {
  Validatable,
  validate,
  Power,
  SunlightIntensity,
  Distance,
} from '@biogrid/grid-simulator';
import { SOLAR_PANEL, GRID_ITEM_NAMES } from '../config';

export class SolarPanel extends EnergySource {
  private sizeSqMtr: number;
  name: string;
  date: Date;
  private weatherLib: WeatherLib;
  /**
   * @param efficiency - default to 17.5% efficiency as solar panels are often between 15% and 20% efficiency
   */
  constructor(
    x: Distance,
    y: Distance,
    sizeSqMtr: number,
    name: string = GRID_ITEM_NAMES.SOLAR_PANEL,
    efficiency = 0.175,
    longitude = 0,
    latitude = 0,
    date: Date = new Date()
  ) {
    super(x, y, efficiency, longitude, latitude);
    if (!this.validateInputsSolarPanel(sizeSqMtr)) {
      throw new Error(
        `Cannot create a solar panel object with values of area ${sizeSqMtr}`
      );
    }
    this.sizeSqMtr = sizeSqMtr;
    this.name = name;
    this.date = date;
    this.weatherLib = new WeatherLib(date, longitude, latitude);
  }

  private validateInputsSolarPanel(area: number) {
    const validator: Validatable = {
      value: area,
      isPositive: area >= 0,
    };
    return validate(validator);
  }

  async getPowerAmount(date: Date): Promise<Power> {
    if (!this.weatherLib.isSetup()) {
      await this.weatherLib.setup();
    }
    const intensity = await this.weatherLib.getSunlight();
    const powerPerSqrMeter = this.intensityToKiloWattsPerSquareMeter(intensity);
    return powerPerSqrMeter * this.sizeSqMtr * this.efficiency;
  }

  supplyPower(requiredPower: Power): Power {
    // TODO implement this when you return the amount of power
    // TODO that the solar panel holds at the particular moment
    // subtract requiredPower from the current and return it, keep track of the remaining power
    return requiredPower;
  }

  /**
   * This method returns the current power that can be generated by
   * the solar panel at that given time
   */
  async getEnergyInJoules(): Promise<Power> {
    return await this.getPowerAmount(this.date);
  }

  async isEmpty() {
    return await this.getEnergyInJoules() === 0;
  }

  private intensityToKiloWattsPerSquareMeter(intensity: SunlightIntensity) {
    // Calculation derived from https://www.researchgate.net/post/Howto_convert_solar_intensity_in_LUX_to_watt_per_meter_square_for_sunlight
    return SOLAR_PANEL.KILOLUX_TO_KILOWATT_PER_SQUARE_METER * intensity;
  }
}
